{% extends "base.html" %}

{% block main_content %}
{%- set separator = config.extra.separator | default(value="•") -%}

{%- set rel_attributes = macros_rel_attributes::rel_attributes() | trim -%}

{%- set blank_target = macros_target_attribute::target_attribute(new_tab=config.markdown.external_links_target_blank) -%}

<main>
    <article class="h-entry">
        <h1 class="p-name article-title">
            {{ page.title | markdown(inline=true) | safe }}
        </h1>
        <a class="u-url u-uid" href="{{ page.permalink | safe }}"></a>

        <ul class="meta">
            {#- Draft indicator -#}
            {% if page.draft %}
                <li class="draft-label">{{ macros_translate::translate(key="draft", default="DRAFT", language_strings=language_strings) }}</li>
            {% endif %}

         {#- Author(s) -#}
            {%- if page.authors or config.author and macros_settings::evaluate_setting_priority(setting="show_author", page=page, default_global_value=false) == "true" -%}
                {%- if page.authors -%}
                    {%- set author_list = page.authors -%}
                {%- else -%}
                    {%- set author_list = [config.author] -%}
                {%- endif -%}

                {%- if author_list | length == 1 -%}
                    {%- set author_string = '<span class="p-author">' ~ author_list.0 ~ '</span>' -%}
                {%- else -%}
                    {%- set last_author = author_list | last -%}
                    {%- set other_authors = author_list | slice(end=-1) -%}
                    {%- set author_separator = macros_translate::translate(key="author_separator", default=", ", language_strings=language_strings) -%}
                   {%- set author_separator = '</span>' ~ author_separator ~ '<span class="p-author">' -%}
                    {%- set conjunction = macros_translate::translate(key="author_conjunction", default=" and ", language_strings=language_strings) -%}
                    {%- set conjunction = '</span>' ~ conjunction ~ '<span class="p-author">' -%}
                    {%- set author_string = other_authors | join(sep=author_separator) -%}
                    {%- set author_string = author_string ~ conjunction ~ last_author -%}
                    {%- set author_string = '<span class="p-author">' ~ author_string ~ '</span>' -%}
                {%- endif -%}

                {%- set by_author = macros_translate::translate(key="by_author", default="By $AUTHOR", language_strings=language_strings) -%}
                <li>{{ by_author | replace(from="$AUTHOR", to=author_string) | safe }}</li>
                {%- set previous_visible = true -%}
            {%- endif -%}

            {%- if config.extra.hcard and config.extra.hcard.enable and ( not author_list or author_list is containing(config.author)) -%}
                {% include "partials/hcard_small.html" %}
            {%- endif -%}

            {%- set separator_with_class = "<span class='separator' aria-hidden='true'>" ~ separator ~ "</span>"-%}

            {#- Date -#}
            {%- if page.date and macros_settings::evaluate_setting_priority(setting="show_date", page=page, default_global_value=true) == "true" -%}
                <li><time class="dt-published" datetime="{{ page.date }}">{%- if previous_visible -%}{{ separator_with_class | safe }}{%- endif -%}{{ macros_format_date::format_date(date=page.date, short=true, language_strings=language_strings) }}</time></li>
                {%- set previous_visible = true -%}
            {%- endif -%}

            {#- Reading time -#}
            {%- if macros_settings::evaluate_setting_priority(setting="show_reading_time", page=page, default_global_value=true) == "true" -%}
                <li title="{{ macros_translate::translate(key="words", number=page.word_count, default="$NUMBER words", language_strings=language_strings) }}">{%- if previous_visible -%}{{ separator_with_class | safe }}{%- endif -%}{{ macros_translate::translate(key="min_read", number=page.reading_time, default="$NUMBER min read", language_strings=language_strings) }}</li>
                {%- set previous_visible = true -%}
            {%- endif -%}

            {#- Tags -#}
            {%- if page.taxonomies and page.taxonomies.tags -%}
                <li class="tag">{%- if previous_visible -%}{{ separator_with_class | safe }}{%- endif -%}{{- macros_translate::translate(key="tags", default="tags", language_strings=language_strings) | capitalize -}}:&nbsp;</li>
                {%- for tag in page.taxonomies.tags -%}
                    <li class="tag"><a class="p-category" href="{{ get_taxonomy_url(kind='tags', name=tag, lang=lang) | safe }}">{{ tag }}</a>
                    {%- if not loop.last -%}
                        ,&nbsp;
                    {%- endif -%}
                    </li>
                {%- endfor -%}
                {%- set previous_visible = true -%}
            {%- endif -%}

            {#- Last updated on -#}
            {% if page.updated %}
                {%- set last_updated_str = macros_translate::translate(key="last_updated_on", default="Updated on $DATE", language_strings=language_strings) -%}
                {%- set formatted_date = macros_format_date::format_date(date=page.updated, short=true, language_strings=language_strings) -%}
                {%- set updated_str = last_updated_str | replace(from="$DATE", to=formatted_date) -%}
                {%- set previous_visible = true -%}
                </ul><ul class="meta last-updated"><li><time class="dt-updated" datetime="{{ page.updated }}">{{ updated_str }}</time></li>
                {#- Show link to remote changes if enabled -#}
                {%- if config.extra.remote_repository_url and macros_settings::evaluate_setting_priority(setting="show_remote_changes", page=page, default_global_value=true) == "true" -%}
                    <li>{%- if previous_visible -%}{{ separator_with_class | safe }}{%- endif -%}<a class="external" href="{% include "partials/history_url.html" %}" {{ blank_target }} rel="{{ rel_attributes }}">{{ macros_translate::translate(key="see_changes", default="See changes", language_strings=language_strings) }}</a></li>
                {%- endif -%}
            {% endif %}
        </ul>

        {%- set series_path_components = [] -%}
        {%- set section_paths = [] -%}
        {%- for path in page.relative_path | split(pat="/") | slice(end=-1) -%}
            {%- set_global series_path_components = series_path_components | concat(with=path) -%}
            {%- set section_path = series_path_components | concat(with="_index.md") | join(sep="/") -%}
            {%- set_global section_paths = section_paths | concat(with=section_path) -%}
        {%- endfor -%}
        {%- for section_path in section_paths | reverse -%}
            {%- set section_file_exists = load_data(path=section_path, required=false) -%}
            {%- if section_file_exists -%}
                {%- set loaded_section = get_section(path=section_path,lang=lang) -%}
                {%- if "series" in loaded_section.extra and loaded_section.extra.series -%}
                    {%- set_global series_section = loaded_section -%}
                    {%- set_global series_ordered_pages = loaded_section.pages -%}
                    {%- if loaded_section.paginated | default(value=0) > 0 and loaded_section.paginate_reversed -%}
                        {%- set_global series_ordered_pages = loaded_section.pages | reverse -%}
                    {%- endif -%}
                    {%- break -%}
                {%- endif -%}
            {%- endif -%}
        {%- endfor -%}

        {% if page.extra.tldr %}
            <div class="admonition note">
                <div class="admonition-icon admonition-icon-note"></div>
                <div class="admonition-content">
                    <strong class="admonition-title">
                        <span title="Too long; didn't read (summary)">TL;DR</span>
                    </strong>
                    <p>{{ page.extra.tldr | markdown | safe }}</p>
                </div>
            </div>
        {% endif %}

        {#- Optional table of contents below the header -#}
        {% if page.toc and macros_settings::evaluate_setting_priority(setting="toc", page=page, default_global_value=false) == "true" %}
            {{ macros_toc::toc(page=page, header=true, language_strings=language_strings) }}
        {% endif %}

        {#- Optional Summary paragraph for readers -#}
        {% if page.description %}
            <p class="p-summary" hidden>{{ page.description }}</p>
        {%- endif -%}


        <section class="e-content body">
            {%- set content_with_intro = page.content -%}
            {%- if "<!-- series_intro -->" in page.content -%}
                {%- set series_intro_html = macros_series_page::get_introduction(page=page, series_section=series_section, series_ordered_pages=series_ordered_pages, language_strings=language_strings) -%}
                {%- set content_with_intro = content_with_intro | replace(from="<!-- series_intro -->", to=series_intro_html) -%}
            {%- elif series_section -%}
                {%- set series_intro_html = macros_series_page::get_introduction(page=page, series_section=series_section, series_ordered_pages=series_ordered_pages, language_strings=language_strings) -%}
                {%- set content_with_intro = series_intro_html ~ content_with_intro -%}
            {%- endif -%}

            {%- set processed_content = content_with_intro -%}
            {%- if "<!-- series_outro -->" in content_with_intro -%}
                {%- set series_outro_html = macros_series_page::get_outro(page=page, series_section=series_section, series_ordered_pages=series_ordered_pages, language_strings=language_strings) -%}
                {%- set processed_content = processed_content | replace(from="<!-- series_outro -->", to=series_outro_html) -%}
            {%- elif series_section -%}
                {%- set series_outro_html = macros_series_page::get_outro(page=page, series_section=series_section, series_ordered_pages=series_ordered_pages, language_strings=language_strings) -%}
                {%- set footnotes_marker = '<hr><ol class="footnotes-list">' -%}
                {%- if footnotes_marker in content_with_intro -%}
                    {%- set content_sections = processed_content | split(pat=footnotes_marker) -%}
                    {%- set main_content = content_sections | first -%}
                    {%- set footnotes_content = content_sections | slice(start=1) | join(sep=footnotes_marker) -%}
                    {%- set processed_content = main_content ~ series_outro_html ~ footnotes_marker ~ footnotes_content -%}
                {%- else -%}
                    {%- set processed_content = processed_content ~ series_outro_html -%}
                {%- endif -%}
            {%- endif -%}

            {{ processed_content | replace(from="<!-- toc -->", to=macros_toc::toc(page=page, header=false, language_strings=language_strings)) | safe }}
        </section>

        {#- Share buttons -#}
        <div class="share-buttons">
            <span class="share-label">Share:</span>
            <a href="https://twitter.com/intent/tweet?url={{ page.permalink | urlencode }}&text={{ page.title | urlencode }}"
               target="_blank" rel="noopener noreferrer" class="share-btn share-x" title="Share on X">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
            </a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ page.permalink | urlencode }}"
               target="_blank" rel="noopener noreferrer" class="share-btn share-linkedin" title="Share on LinkedIn">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
            </a>
        </div>

        {#- iine button -#}
        {%- if macros_settings::evaluate_setting_priority(setting="iine", page=page, default_global_value=false) == "true" -%}
            {% include "partials/iine_button.html" %}
        {%- endif -%}

        {% if macros_settings::evaluate_setting_priority(setting="show_previous_next_article_links", page=page, default_global_value=true) == "true" %}
            {%- if page.lower or page.higher -%}
                {% set next_label = macros_translate::translate(key="next", default="Next", language_strings=language_strings) %}
                {% set prev_label = macros_translate::translate(key="prev", default="Prev", language_strings=language_strings) %}
                {% if macros_settings::evaluate_setting_priority(setting="invert_previous_next_article_links", page=page, default_global_value=true) == "true" %}
                    {% if page.higher %}
                        {% set left_link = page.higher.permalink %}
                        {% set left_label = prev_label %}
                        {% set left_title = page.higher.title %}
                    {% endif %}
                    {% if page.lower %}
                        {% set right_link = page.lower.permalink %}
                        {% set right_label = next_label %}
                        {% set right_title = page.lower.title %}
                    {% endif %}
                {% else %}
                    {% if page.lower %}
                        {% set left_link = page.lower.permalink %}
                        {% set left_label = next_label %}
                        {% set left_title = page.lower.title %}
                    {% endif %}
                    {% if page.higher %}
                        {% set right_link = page.higher.permalink %}
                        {% set right_label = prev_label %}
                        {% set right_title = page.higher.title %}
                    {% endif %}
                {% endif %}
                {% if macros_settings::evaluate_setting_priority(setting="previous_next_article_links_full_width", page=page, default_global_value=true) == "true" %}
                    {%- set full_width_class = "full-width" -%}
                {% endif %}
            <nav class="{{ full_width_class | default(value="") }} article-navigation">
                <div>
                {%- if left_link and left_label and left_title -%}
                <a href="{{ left_link | safe }}" aria-label="{{ left_label }}" aria-describedby="left_title"><span class="arrow">←</span>&nbsp;{{ left_label }}</a>
                <p aria-hidden="true" id="left_title">{{ left_title | truncate(length=100, end="…") | markdown(inline=true) | safe }}</p>
                {%- endif -%}
                </div>
                <div>
                {%- if right_link and right_label and right_title -%}
                <a href="{{ right_link | safe }}" aria-label="{{ right_label }}" aria-describedby="right_title">{{ right_label }}&nbsp;<span class="arrow">→</span></a>
                <p aria-hidden="true" id="right_title">{{ right_title | truncate(length=100, end="…") | markdown(inline=true) | safe }}</p>
                {%- endif -%}
                </div>
            </nav>
            {%- endif -%}
        {%- endif -%}

        {#- Comments -#}
        {% set systems = ["giscus", "utterances", "hyvortalk", "isso"] %}
        {% set enabled_systems = 0 %}
        {% set comment_system = "" %}

        {% for system in systems %}
            {% set global_enabled = config.extra[system].enabled_for_all_posts | default(value=false) %}
            {% set page_enabled = page.extra[system] | default(value=global_enabled) %}
            {% set is_enabled = global_enabled and page_enabled != false or page_enabled == true %}

            {% if is_enabled %}
                {% set_global comment_system = system %}
                {% set_global enabled_systems = enabled_systems + 1 %}
            {% endif %}
        {% endfor %}
        {% if enabled_systems > 1 %}
            {{ throw(message="ERROR: Multiple comment systems have been enabled for the same page. Check your config.toml and individual page settings to ensure only one comment system is activated at a time.") }}
        {% endif %}
        {% if comment_system %}
            {% include "partials/comments.html" %}
        {% endif %}

        {#- Webmentions -#}
        {%- set global_webmentions_enabled = config.extra.webmentions.enable | default(value=false) -%}
        {%- set page_webmentions_enabled = page.extra.webmentions | default(value=global_webmentions_enabled) -%}
        {%- set webmentions_enabled = global_webmentions_enabled and page_webmentions_enabled != false or page_webmentions_enabled == true -%}
        {%- if webmentions_enabled -%}
            {%- include "partials/webmentions.html" -%}
        {%- endif -%}

    </article>
</main>

{%- include "partials/extra_features.html" -%}

{% endblock main_content %}
